import streamlit as st
import numpy as np
import pickle
import warnings
from sentence_transformers import SentenceTransformer
import pandas as pd

# Suppress all warnings
warnings.filterwarnings("ignore")

# Load the embedding model
model = SentenceTransformer('sentence-transformers/all-mpnet-base-v2')

# Function to predict metrics
def predict_metrics(description):
    embedding = model.encode(description, convert_to_tensor=True).cpu().numpy().reshape(1, -1)

    base_path = r'C:\Users\pradeep dubey\Desktop\NLP_Project\MODELS2'
    regression_models = {
        "Impact_Score": base_path + "\Impact_Score_xgb_regressor.pkl",
        "Base_Score": base_path + "\BASE_SCORE_xgb_regressor.pkl",
        "Exploitability_Score": base_path + "\Exploitability_Score_xgb_regressor.pkl"
    }

    classification_models = {
        "Access_Complexity": (base_path + "\\Access_Complexity_best_catboost_model.pkl", base_path + "\\Access_Complexity_label_encoder.pkl"),
        "Access_Vector": (base_path + "\\accessVector_best_catboost_model.pkl", base_path + "\\Access_Vector_label_encoder.pkl"),
        "Availability_Impact": (base_path + "\\Availability_Impact_best_catboost_model.pkl", base_path + "\\Availability_Impact_label_encoder.pkl"),
        "Confidentiality_Impact": (base_path + "\\Confidentiality_Impact_best_xgboost_model.pkl", base_path + "\\Confidentiality_Impact_label_encoder.pkl"),
        "Integrity_Impact": (base_path + "\\Integrity_Impact_best_xgboost_model.pkl", base_path + "\\Integrity_Impact_label_encoder.pkl"),
    }

    predicted_outputs = {}

    for target, model_file in regression_models.items():
        with open(model_file, 'rb') as file:
            loaded_model = pickle.load(file)
        predicted_output = loaded_model.predict(embedding).flatten()
        predicted_outputs[target] = predicted_output[0]

    for target, (model_file, encoder_file) in classification_models.items():
        with open(encoder_file, 'rb') as f:
            label_encoder = pickle.load(f)
        with open(model_file, 'rb') as f:
            best_model = pickle.load(f)
        predicted_label_encoded = best_model.predict(embedding).flatten()
        predicted_label = label_encoder.inverse_transform(predicted_label_encoded.astype(int))
        predicted_outputs[target] = predicted_label[0]

    return predicted_outputs

# Streamlit UI Configuration
st.set_page_config(page_title="Cybersecurity Vulnerability Predictor", page_icon="üîí")

# Custom CSS for styling
st.markdown("""
    <style>
        /* Global background color */
        .main {
            background-color: #2e2e2e;
            color: #FFFFFF;
            padding: 30px;
        }

        /* Title style */
        .title {
            font-size: 3em;
            font-weight: bold;
            color: #FFFFFF;
            text-align: center;
            margin-top: 20px;
            animation: fadeInTitle 2s ease-in;
        }

        /* Button styling */
        div.stButton > button {
            background-color: #FF6B6B;
            color: white;
            font-size: 20px;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 12px;
            transition: background-color 0.3s ease;
            animation: pulse 2s infinite;
        }
        div.stButton > button:hover {
            background-color: #FF4B4B;
        }

        /* Fade-in animation */
        @keyframes fadeInTitle {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Pulsing button animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Table Styling */
        .table {
            background-color: #333333;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .table th {
            color: #FFFFFF;
            font-weight: bold;
            font-size: 20px;
        }

        .table td {
            color: #FFFFFF;
            font-size: 18px;
        }

        /* Footer */
        footer {
            font-size: 1.2em;
            text-align: center;
            color: #aaaaaa;
            margin-top: 30px;
        }
    </style>
""", unsafe_allow_html=True)

# App title with emoji
st.markdown("<h1 class='title'>üîí Cybersecurity Vulnerability Metric Predictor</h1>", unsafe_allow_html=True)
st.markdown("<p style='text-align: center; font-size: 1.3em; color: #bbbbbb;'>Leverage AI to assess key security metrics for your cybersecurity descriptions.</p>", unsafe_allow_html=True)

# User input area with dark background
st.markdown("### üìù Enter Vulnerability Description")
description = st.text_area("Enter description here:", placeholder="Type a detailed vulnerability description...", height=150)

# Predict button
if st.button("üîç Predict Metrics"):
    if description.strip():
        # Run prediction
        predicted_metrics = predict_metrics(description)
        
        # Display predicted metrics in a table
        st.markdown("<div class='table'>", unsafe_allow_html=True)
        # Create a DataFrame to display predictions in tabular format
        df = pd.DataFrame(list(predicted_metrics.items()), columns=["Metric", "Prediction"])
        st.table(df)
        st.markdown("</div>", unsafe_allow_html=True)
    else:
        st.warning("‚ö†Ô∏è Please enter a vulnerability description to predict metrics.")

# Footer with improved contrast and styling
st.markdown("<hr style='border: 1px solid #555;'>", unsafe_allow_html=True)
st.markdown("<footer>Built with ‚ù§Ô∏è using Streamlit & Machine Learning</footer>", unsafe_allow_html=True)
st.markdown("<footer>üåê Connect with us on [GitHub](https://github.com) | [LinkedIn](https://linkedin.com)</footer>", unsafe_allow_html=True)
